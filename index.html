[⚠️ Suspicious Content] <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventSphere - Simple Frontend</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- qrcode.js CDN for client-side QR code generation -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <style>
        /* Ensure html and body take full height */
        html, body {
            height: 100%; 
        }
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            min-height: 100vh; /* Ensures body is at least viewport height */
            display: flex;
            flex-direction: column;
            background: linear-gradient(to bottom right, #8B5CF6, #3B82F6); /* Purple to Blue Gradient */
            color: #E5E7EB; /* Light gray text */
        }
        #app-container {
            flex-grow: 1; /* Allows container to grow and take available space */
            display: flex;
            flex-direction: column;
            align-items: center; /* Center content horizontally */
            padding: 1rem; /* Overall padding */
            width: 100%; /* Ensure it takes full width */
            box-sizing: border-box; /* Include padding in width/height calculation */
        }
        /* Navigation button styling */
        .nav-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 9999px; /* Rounded-full */
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* Slightly more pronounced shadow */
            border: 1px solid rgba(255, 255, 255, 0.3); /* Subtle border for definition */
            backdrop-filter: blur(5px); /* Ensure blur is applied */
        }
        .nav-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px); /* Slight lift effect */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* Larger shadow on hover */
        }
        /* Form element styling */
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem; /* rounded-lg */
            background-color: rgba(255, 255, 255, 0.15); /* Slightly less transparent */
            border: 1px solid rgba(255, 255, 255, 0.4); /* Stronger border */
            color: #E5E7EB;
            outline: none;
            transition: all 0.2s ease-in-out;
        }
        .form-input::placeholder, .form-textarea::placeholder {
            color: #CBD5E0; /* Lighter gray for placeholder */
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            border-color: #6366F1; /* Indigo-500 */
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.6); /* Thicker ring on focus */
            background-color: rgba(255, 255, 255, 0.25); /* More opaque on focus */
        }

        /* General card/content box styling */
        .content-card {
            background-color: rgba(255, 255, 255, 0.2); /* Slightly lighter background */
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 1.25rem; /* rounded-xl for content cards */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Deeper shadow */
        }

        .footer-text {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            margin-top: auto; /* Pushes the footer to the bottom */
            padding-top: 2rem; /* Spacing from content */
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Navigation Bar - Fixed at the top, spans full width, transparent, with blur -->
        <nav class="fixed top-0 left-0 w-full bg-white bg-opacity-20 backdrop-filter backdrop-blur-lg px-6 py-3 shadow-lg flex justify-between items-center z-50">
            <div class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar text-white drop-shadow-lg"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                <h1 class="text-3xl font-extrabold text-white drop-shadow-lg">EventSphere</h1>
            </div>
            <div class="flex items-center gap-4">
                <!-- Smart Home button -->
                <button onclick="handleHomeButtonClick()" class="nav-btn" title="Home">
                    Home
                </button>
                <div id="auth-buttons" class="flex items-center gap-2">
                    <!-- Auth buttons will be rendered here by JS -->
                </div>
            </div>
        </nav>

        <!-- Main Content Area - Pushed down to clear the fixed header -->
        <main class="flex-grow flex items-start justify-center pt-24 pb-8 w-full max-w-5xl"> 
            <div id="content-area" class="container mx-auto w-full">
                <!-- Content will be rendered here by JS -->
            </div>
        </main>

        <!-- Modal Overlay -->
        <div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md border border-gray-300">
                <h3 id="modal-title" class="text-2xl font-bold mb-4 text-gray-900"></h3>
                <p id="modal-message" class="text-gray-700 mb-6"></p>
                <div class="flex justify-end gap-3">
                    <button id="modal-cancel-btn" class="hidden px-5 py-2 rounded-lg bg-gray-300 text-gray-800 font-semibold hover:bg-gray-400 transition-colors">Cancel</button>
                    <button id="modal-confirm-btn" class="px-5 py-2 rounded-lg font-semibold transition-colors bg-blue-500 text-white hover:bg-blue-600">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration (REPLACED WITH YOUR AWS DETAILS) ---
        const AWS_REGION = 'us-east-1'; 
        const COGNITO_USER_POOL_ID = 'us-east-1_XgyeAkGsm'; 
        const COGNITO_USER_POOL_CLIENT_ID = '7jlpbpk9964imvoa9s4mdagmm8'; 
        const COGNITO_DOMAIN = 'eventsphere-yourname-app.auth.us-east-1.amazoncognito.com'; 
        
        const REDIRECT_SIGN_IN_URL = 'https://main.d7icjcyxhs1jd.amplifyapp.com/'; 
        const REDIRECT_SIGN_OUT_URL = 'https://main.d7icjcyxhs1jd.amplifyapp.com/'; 

        const API_GATEWAY_BASE_URL = 'https://8t48bgp8t6.execute-api.us-east-1.amazonaws.com/dev'; 
        const API_GATEWAY_EVENTS_URL = API_GATEWAY_BASE_URL + '/events'; 
        const API_GATEWAY_UPDATE_ROLE_URL = API_GATEWAY_BASE_URL + '/updateRole'; 
        const API_GATEWAY_GET_TICKET_URL = API_GATEWAY_BASE_URL + '/ticket'; 


        // --- Global State Variables ---
        let loggedInUser = null; 
        let events = []; 
        let currentEvent = null; 
        let currentView = 'home'; 
        let editingEventId = null; 
        let form = { name: '', date: '', description: '', location: '', organizerId: '' }; 

        // Store the ticket URL returned from generateTicketPDF Lambda
        let generatedTicketUrl = null;


        // --- Helper Functions (UI & Data) ---

        // Lucide Icons (as SVG strings)
        const getIconSVG = (name, size = 20) => {
            const icons = {
                'login': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-in"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>`,
                'user-plus': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-plus"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>`,
                'settings': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.44.25a2 2 0 0 0-2 0L3.7 7.35a2 2 0 0 0-1 1.73v.44a2 2 0 0 1-1 1.73l-.44.25a2 2 0 0 0-2 0L.1 12.65a2 2 0 0 0 0 1.73l.44.25a2 2 0 0 1 1 1.73v.44a2 2 0 0 0 2 0l.44-.25a2 2 0 0 1 1.73 1L7.35 20.3a2 2 0 0 0 1.73 1v.44a2 2 0 0 1 2 2h.44a2 2 0 0 1 2-2v-.18a2 2 0 0 0 1-1.73l.44-.25a2 2 0 0 0 2 0L20.3 16.65a2 2 0 0 0 1-1.73v-.44a2 2 0 0 1 1-1.73l.44-.25a2 2 0 0 0 2 0L23.9 11.35a2 2 0 0 0 0-1.73l-.44-.25a2 2 0 0 1-1-1.73V7.35a2 2 0 0 0-2 0l-.44.25a2 2 0 0 1-1.73-1L16.65 3.7a2 2 0 0 0-1.73-1z"/><circle cx="12" cy="12" r="3"/></svg>`,
                'user': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
                'home': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
                'plus-circle': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>`,
                'edit': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z"/></svg>`,
                'trash-2': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>`,
                'calendar': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>`,
                'file-text': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>`,
                'download': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>`,
                'qr-code': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-qr-code"><rect width="8" height="8" x="2" y="2" rx="1"/><rect width="8" height="8" x="14" y="2" rx="1"/><rect width="8" height="8" x="2" y="14" rx="1"/><path d="M7 7h.01"/><path d="M19 7h.01"/><path d="M7 19h.01"/><path d="M17 17h.01"/><path d="M14 12v-2a2 2 0 0 1 2-2h2"/><path d="M14 14h.01"/><path d="M14 17h.01"/><path d="M17 14h.01"/><path d="M22 17h-4a2 0 0 0-2 2v4"/><path d="M12 22h.01"/><path d="M22 12v.01"/></svg>`,
                'credit-card': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-credit-card"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>`,
                'user-x': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-x"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="17" x2="22" y1="17" y2="22"/><line x1="22" x2="17" y1="17" y2="22"/></svg>`,
                'book-open': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-book-open"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h6z"/></svg>`
            };
            // The QR code SVG is removed, as it will be generated by qrcode.js
            if (name === 'qr-code') return ''; 
            return icons[name] || '';
        };

        // Custom Alert/Confirmation Modal (using direct DOM manipulation)
        const modalOverlay = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        const showAlert = (title, message, onConfirmCallback = () => {}) => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalConfirmBtn.textContent = 'OK';
            modalConfirmBtn.onclick = () => {
                modalOverlay.classList.add('hidden');
                onConfirmCallback();
            };
            modalCancelBtn.classList.add('hidden'); // Hide cancel button for alerts
            modalConfirmBtn.classList.remove('bg-red-500', 'hover:bg-red-600'); // Ensure blue for OK
            modalConfirmBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            modalOverlay.classList.remove('hidden');
        };

        const showConfirm = (title, message, onConfirmCallback = () => {}, onCancelCallback = () => {}) => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalConfirmBtn.textContent = 'Confirm';
            modalConfirmBtn.onclick = () => {
                modalOverlay.classList.add('hidden');
                onConfirmCallback();
            };
            modalCancelBtn.textContent = 'Cancel';
            modalCancelBtn.onclick = () => {
                modalOverlay.classList.add('hidden');
                onCancelCallback();
            };
            modalConfirmBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            modalConfirmBtn.classList.add('bg-red-500', 'hover:bg-red-600'); // Red for Confirm
            modalCancelBtn.classList.remove('hidden'); // Show cancel button for confirms
            modalOverlay.classList.remove('hidden');
        };

        // Real QR Code Generator (using qrcode.js library)
        const generateQRCode = (text, elementId, size = 256) => {
            const qrCodeDiv = document.getElementById(elementId);
            if (qrCodeDiv) {
                qrCodeDiv.innerHTML = ''; // Clear any previous QR code or placeholder
                new QRCode(qrCodeDiv, {
                    text: text,
                    width: size,
                    height: size,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H // High error correction
                });
            } else {
                console.warn(`QR Code target element with ID '${elementId}' not found.`);
            }
        };

        // --- Core UI Renderer ---
        const renderUI = () => {
            const contentArea = document.getElementById('content-area');
            const authButtonsDiv = document.getElementById('auth-buttons');
            authButtonsDiv.innerHTML = ''; // Clear existing buttons

            // Render Auth Buttons in Navigation
            if (loggedInUser) {
                // If logged in, show user role button and logout
                const roleButtonHTML = loggedInUser.role === 'organizer' ?
                    `<button onclick="setView('organizerDashboard')" class="nav-btn" title="Organizer Dashboard">${getIconSVG('settings', 20)} <span class="hidden sm:inline">Organizer</span></button>` :
                    `<button onclick="setView('attendeePortal')" class="nav-btn" title="Attendee Portal">${getIconSVG('user', 20)} <span class="hidden sm:inline">Attendee</span></button>`;
                
                authButtonsDiv.innerHTML = `
                    ${roleButtonHTML}
                    <span class="text-white text-sm hidden md:inline ml-2">Welcome, ${loggedInUser.email}</span>
                    <button onclick="handleLogout()" class="nav-btn bg-red-500 hover:bg-red-600" title="Logout">
                        ${getIconSVG('login', 20)} <span class="hidden sm:inline">Logout</span>
                    </button>
                `;
            } else {
                // If not logged in, show Login and Sign Up
                authButtonsDiv.innerHTML = `
                    <button onclick="redirectToCognitoLogin()" class="nav-btn" title="Login">
                        ${getIconSVG('login', 20)} <span class="hidden sm:inline">Login</span>
                    </button>
                    <button onclick="setView('signupRoleSelection')" class="nav-btn" title="Sign Up">
                        ${getIconSVG('user-plus', 20)} <span class="hidden sm:inline">Sign Up</span>
                    </button>
                `;
            }

            // Render Main Content based on currentView
            let htmlContent = '';
            let showFooter = false; // Flag to control footer display

            switch (currentView) {
                case 'home':
                    showFooter = true; // Show footer on home page
                    htmlContent = `
                        <div class="flex flex-col items-center justify-center text-center py-16 px-4 content-card">
                            <h2 class="text-5xl font-extrabold mb-6 drop-shadow-lg text-gray-900">Welcome to EventSphere!</h2>
                            <p class="text-xl text-gray-700 mb-10 max-w-2xl">
                                Your complete platform for creating, managing, and attending events.
                                Seamlessly organize and enjoy memorable experiences.
                            </p>
                            ${loggedInUser ? `
                                <p class="text-lg text-gray-700">You are logged in as ${loggedInUser.email}.</p>
                                <div class="flex flex-col sm:flex-row gap-6 mt-6">
                                    <button onclick="handleHomeButtonClick()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 flex items-center justify-center gap-2">
                                        Go to your Dashboard
                                    </button>
                                    <button onclick="setView('tutorial')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 flex items-center justify-center gap-2">
                                        ${getIconSVG('book-open', 24)} Tutorial
                                    </button>
                                </div>
                            ` : `
                                <div class="flex flex-col sm:flex-row gap-6">
                                    <button onclick="redirectToCognitoLogin()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 flex items-center justify-center gap-2">
                                        ${getIconSVG('login', 24)} Login
                                    </button>
                                    <button onclick="setView('signupRoleSelection')" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 flex items-center justify-center gap-2">
                                        ${getIconSVG('user-plus', 24)} Sign Up
                                    </button>
                                </div>
                            `}
                        </div>
                    `;
                    break;
                case 'signupRoleSelection':
                    showFooter = true; // Show footer on signup selection page
                    htmlContent = `
                        <div class="max-w-md mx-auto p-8 content-card text-center">
                            <h2 class="text-3xl font-bold mb-8 text-gray-900">Sign Up As...</h2>
                            <p class="text-lg text-gray-700 mb-6">Choose your primary role for EventSphere:</p>
                            <div class="flex flex-col gap-4">
                                <!-- Both buttons go to generic Hosted UI signup -->
                                <button onclick="redirectToCognitoSignup()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-all duration-300 transform hover:scale-105 shadow-lg">
                                    ${getIconSVG('settings', 24)} Event Organizer
                                </button>
                                <button onclick="redirectToCognitoSignup()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-all duration-300 transform hover:scale-105 shadow-lg">
                                    ${getIconSVG('user', 24)} Event Attendee
                                </button>
                            </div>
                            <p class="text-center mt-6 text-gray-700">
                                Already have an account? 
                                <button onclick="redirectToCognitoLogin()" class="text-blue-600 hover:underline font-semibold">
                                    Login
                                </button>
                            </p>
                        </div>
                    `;
                    break;
                case 'chooseRoleAfterLogin': // New view for role selection AFTER initial login
                    htmlContent = `
                        <div class="max-w-md mx-auto p-8 content-card text-center">
                            <h2 class="text-3xl font-bold mb-8 text-gray-900">Welcome, ${loggedInUser?.email || 'New User'}!</h2>
                            <p class="text-lg text-gray-700 mb-6">It looks like this is your first time here, or your role hasn't been set. Please choose your role to get started:</p>
                            <div class="flex flex-col gap-4">
                                <button onclick="handleAssignRole('organizer')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-all duration-300 transform hover:scale-105 shadow-lg">
                                    ${getIconSVG('settings', 24)} I am an Event Organizer
                                </button>
                                <button onclick="handleAssignRole('attendee')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-all duration-300 transform hover:scale-105 shadow-lg">
                                    ${getIconSVG('user', 24)} I am an Event Attendee
                                </button>
                            </div>
                        </div>
                    `;
                    break;
                case 'organizerDashboard':
                    if (!loggedInUser || loggedInUser.role !== 'organizer') {
                        htmlContent = renderAccessDenied();
                    } else {
                        const myEvents = events.filter(event => event.organizerId === loggedInUser.id);
                        htmlContent = `
                            <div class="p-4 w-full">
                                <h2 class="text-4xl font-bold mb-8 text-center drop-shadow-lg text-white">Organizer Dashboard</h2>
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="text-2xl font-semibold text-white">Your Events</h3>
                                    <button onclick="setView('createEvent')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-all duration-300 transform hover:scale-105 shadow-md">
                                        ${getIconSVG('plus-circle', 20)} Create New Event
                                    </button>
                                </div>
                                ${myEvents.length === 0 ? `
                                    <p class="text-center text-lg text-gray-300">You haven't created any events yet.</p>
                                ` : `
                                    <div class="space-y-4">
                                        ${myEvents.map(event => `
                                            <div class="content-card p-5 flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                                                <div>
                                                    <h3 class="text-2xl font-semibold mb-1 text-gray-900">${event.name}</h3>
                                                    <p class="text-lg text-gray-800 flex items-center gap-2 mb-1">
                                                        ${getIconSVG('calendar', 18)} ${event.date}
                                                    </p>
                                                    <p class="text-gray-700 text-sm italic">${event.location}</p>
                                                    <p class="text-gray-700 text-sm mt-2">
                                                        <span class="font-bold">${event.registeredAttendees.length}</span> Registrations
                                                    </p>
                                                </div>
                                                <div class="flex flex-col md:flex-row gap-2 mt-3 md:mt-0">
                                                    <button onclick="handleEditEventClick('${event.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-1 transition-all duration-300 transform hover:scale-105 shadow-md">
                                                        ${getIconSVG('edit', 18)} Edit
                                                    </button>
                                                    <button onclick="handleDeleteEvent('${event.id}')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-1 transition-all duration-300 transform hover:scale-105 shadow-md">
                                                        ${getIconSVG('trash-2', 18)} Delete
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        `;
                    }
                    break;
                case 'createEvent':
                    if (!loggedInUser || loggedInUser.role !== 'organizer') {
                        htmlContent = renderAccessDenied();
                    } else {
                        htmlContent = `
                            <div class="max-w-xl mx-auto p-8 content-card">
                                <h2 class="text-3xl font-bold text-center mb-8 text-gray-900">${editingEventId ? 'Edit Event' : 'Create New Event'}</h2>
                                <form id="event-form" class="space-y-6">
                                    <div>
                                        <label for="eventName" class="block text-sm font-semibold mb-2 text-gray-800">Event Name</label>
                                        <input type="text" id="eventName" class="form-input" placeholder="Concert, Workshop, Meeting..." value="${form.name}" required>
                                    </div>
                                    <div>
                                        <label for="eventDate" class="block text-sm font-semibold mb-2 text-gray-800">Event Date</label>
                                        <input type="date" id="eventDate" class="form-input" value="${form.date}" required>
                                    </div>
                                    <div>
                                        <label for="eventLocation" class="block text-sm font-semibold mb-2 text-gray-800">Event Location</label>
                                        <input type="text" id="eventLocation" class="form-input" placeholder="e.g., Grand Exhibition Hall" value="${form.location}" required>
                                    </div>
                                    <div>
                                        <label for="eventDescription" class="block text-sm font-semibold mb-2 text-gray-800">Description (Optional)</label>
                                        <textarea id="eventDescription" rows="4" class="form-textarea resize-y" placeholder="Brief description of the event...">${form.description}</textarea>
                                    </div>
                                    <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-all duration-300 transform hover:scale-105 shadow-lg">
                                        ${getIconSVG('plus-circle', 20)} ${editingEventId ? 'Update Event' : 'Create Event'}
                                    </button>
                                </form>
                            </div>
                        `;
                    }
                    break;
                case 'attendeePortal':
                    if (!loggedInUser || loggedInUser.role !== 'attendee') {
                        htmlContent = renderAccessDenied();
                    } else {
                        htmlContent = `
                            <div class="p-4 w-full">
                                <h2 class="text-4xl font-bold mb-8 text-center drop-shadow-lg text-white">Attendee Portal</h2>
                                <h3 class="text-2xl font-semibold mb-6 text-white">Browse Events</h3>
                                ${events.length === 0 ? `
                                    <p class="text-center text-lg text-gray-300">No events available at the moment.</p>
                                ` : `
                                    <div class="space-y-6">
                                        ${events.map(event => `
                                            <div class="content-card p-5 flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                                                <div>
                                                    <h3 class="text-2xl font-semibold mb-1 text-gray-900">${event.name}</h3>
                                                    <p class="text-lg text-gray-800 flex items-center gap-2 mb-1">
                                                        ${getIconSVG('calendar', 18)} ${event.date} at ${event.location}
                                                    </p>
                                                    ${event.description ? `<p class="text-gray-700 text-sm italic">${event.description}</p>` : ''}
                                                    ${loggedInUser && event.registeredAttendees.includes(loggedInUser.id) ? `
                                                        <p class="text-green-700 text-md font-semibold mt-2 flex items-center gap-1">
                                                            You are registered!
                                                        </p>
                                                    ` : ''}
                                                </div>
                                                <div class="flex flex-col md:flex-row gap-2 mt-3 md:mt-0">
                                                    ${!loggedInUser || !event.registeredAttendees.includes(loggedInUser.id) ? `
                                                        <button onclick="handleRegisterOrDeregisterForEvent('${event.id}', 'register')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-1 transition-all duration-300 transform hover:scale-105 shadow-md">
                                                            ${getIconSVG('user-plus', 18)} Register
                                                        </button>
                                                    ` : `
                                                        <button onclick="handleRegisterOrDeregisterForEvent('${event.id}', 'deregister')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-1 transition-all duration-300 transform hover:scale-105 shadow-md">
                                                            ${getIconSVG('user-x', 18)} De-register
                                                        </button>
                                                        <button onclick="handleDownloadTicket('${event.id}')" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-1 transition-all duration-300 transform hover:scale-105 shadow-md">
                                                            ${getIconSVG('download', 18)} Download Ticket
                                                        </button>
                                                    `}
                                                    <button onclick="viewEventDetails('${event.id}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-1 transition-all duration-300 transform hover:scale-105 shadow-md">
                                                        ${getIconSVG('file-text', 18)} Details
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}

                                <!-- Display QR code if a ticket was "downloaded" and currentEvent is set -->
                                ${currentEvent && currentView === 'attendeePortal' && loggedInUser && currentEvent.registeredAttendees.includes(loggedInUser.id) && generatedTicketUrl ? `
                                    <div class="mt-8 p-6 content-card text-center">
                                        <h3 class="text-xl font-bold mb-4 text-gray-900">Your Ticket QR Code for ${currentEvent.name}</h3>
                                        <!-- QR code will be generated into this div -->
                                        <div class="bg-white p-4 rounded-lg inline-block" id="attendee-ticket-qrcode-display">
                                            </div>
                                        <p class="text-gray-800 text-sm mt-4">Scan this QR code to download your ticket.</p>
                                        <button onclick="setCurrentEvent(null); generatedTicketUrl = null; renderUI();" class="mt-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                                            Close Ticket Preview
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                    break;
                case 'eventDetails':
                    if (!currentEvent) {
                        htmlContent = `<p class="text-center text-gray-300">No event selected.</p>`;
                    } else {
                        const isRegistered = loggedInUser && currentEvent.registeredAttendees.includes(loggedInUser.id);
                        htmlContent = `
                            <div class="max-w-2xl mx-auto p-8 content-card">
                                <h2 class="text-4xl font-bold mb-4 text-center text-gray-900">${currentEvent.name}</h2>
                                <p class="text-lg text-gray-800 mb-2 flex items-center gap-2 justify-center">
                                    ${getIconSVG('calendar', 20)} ${currentEvent.date} at ${currentEvent.location}
                                </p>
                                <p class="text-gray-700 text-md text-center mb-6">${currentEvent.description}</p>

                                <div class="flex justify-center gap-4 mb-8">
                                    ${loggedInUser && loggedInUser.role === 'attendee' ? (
                                        !isRegistered ? `
                                            <button onclick="handleRegisterOrDeregisterForEvent('${currentEvent.id}', 'register'); handleMockPayment(99.99, 'USD', '${currentEvent.name}');" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-all duration-300 transform hover:scale-105 shadow-md">
                                                ${getIconSVG('credit-card', 20)} Register & Pay (Mock)
                                            </button>
                                        ` : `
                                            <button onclick="handleRegisterOrDeregisterForEvent('${currentEvent.id}', 'deregister')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-all duration-300 transform hover:scale-105 shadow-md">
                                                ${getIconSVG('user-x', 20)} De-register
                                            </button>
                                            <button onclick="handleDownloadTicket('${currentEvent.id}')" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-all duration-300 transform hover:scale-105 shadow-md">
                                                ${getIconSVG('download', 20)} Download Ticket
                                            </button>
                                        `
                                    ) : ''}
                                </div>

                                ${isRegistered && generatedTicketUrl ? `
                                    <div class="mt-6 p-6 content-card text-center">
                                        <h3 class="text-xl font-bold mb-4 text-gray-900">Your Ticket QR Code</h3>
                                        <!-- QR code will be generated into this div -->
                                        <div class="bg-white p-4 rounded-lg inline-block" id="event-details-qrcode-display">
                                        </div>
                                        <p class="text-gray-800 text-sm mt-4">Scan this QR code to download your ticket.</p>
                                        <button onclick="setCurrentEvent(null); generatedTicketUrl = null; setView('attendeePortal');" class="mt-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                                            Close Ticket Preview
                                        </button>
                                    </div>
                                ` : ''}

                                <div class="text-center mt-8">
                                    <button onclick="setView('attendeePortal')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-5 rounded-lg transition-colors">
                                        Back to All Events
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                    break;
                case 'tutorial':
                    htmlContent = `
                        <div class="max-w-3xl mx-auto p-8 content-card text-gray-900">
                            <h2 class="text-4xl font-bold text-center mb-8">How to Use EventSphere</h2>
                            <div class="space-y-6 text-lg">
                                <section>
                                    <h3 class="text-2xl font-semibold mb-3 text-indigo-700">1. Sign Up & Login</h3>
                                    <p>First, create an account. You can choose to be an <strong>Event Organizer</strong> to host events or an <strong>Event Attendee</strong> to find and join them. If your role isn't assigned, you'll be prompted after your first login.</p>
                                </section>
                                <section>
                                    <h3 class="text-2xl font-semibold mb-3 text-indigo-700">2. For Event Organizers</h3>
                                    <ul class="list-disc list-inside space-y-2 ml-4">
                                        <li><strong>Create Events:</strong> On your dashboard, click "Create New Event". Fill in the details like name, date, location, and description.</li>
                                        <li><strong>Manage Events:</strong> Your dashboard shows all events you've created. You can "Edit" or "Delete" them. You'll also see how many attendees have registered for each event.</li>
                                        <li><strong>Event Details:</strong> View registered attendees count directly on your dashboard.</li>
                                    </ul>
                                </section>
                                <section>
                                    <h3 class="text-2xl font-semibold mb-3 text-indigo-700">3. For Event Attendees</h3>
                                    <ul class="list-disc list-inside space-y-2 ml-4">
                                        <li><strong>Browse Events:</strong> Your portal shows all public events. Scroll through the list to find events that interest you.</li>
                                        <li><strong>Register:</strong> Click "Register" on an event to sign up. A mock payment will be simulated.</li>
                                        <li><strong>De-register:</strong> If you change your mind, click "De-register" to remove your registration.</li>
                                        <li><strong>Download Ticket:</strong> For events you're registered for, click "Download Ticket". A QR code will also appear on the screen, which you can scan to quickly access your ticket.</li>
                                        <li><strong>View Details:</strong> Click "Details" to see more information about any event.</li>
                                    </ul>
                                </section>
                                <section>
                                    <h3 class="text-2xl font-semibold mb-3 text-indigo-700">4. Staying Logged In</h3>
                                    <p>Your session will persist across browser refreshes so you don't have to log in every time (up to 8 hours by default). If your session expires, you'll be prompted to log in again.</p>
                                </section>
                            </div>
                            <div class="text-center mt-8">
                                <button onclick="handleHomeButtonClick()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-5 rounded-lg transition-colors">
                                    Back to Dashboard
                                </button>
                            </div>
                        </div>
                    `;
                    break;
                default: // Access denied for unauthorized views
                    htmlContent = renderAccessDenied();
            }
            contentArea.innerHTML = htmlContent;

            // --- Conditionally add "Made with love" footer ---
            if (showFooter) {
                const footerDiv = document.createElement('div');
                footerDiv.className = 'footer-text';
                footerDiv.innerHTML = '<p>Made with ❤️ in the AWS cloud</p>';
                contentArea.appendChild(footerDiv);
            }

            // --- Post-render QR code generation ---
            // Only generate QR code if generatedTicketUrl exists and the relevant div is present
            if (generatedTicketUrl && currentView === 'attendeePortal' && document.getElementById('attendee-ticket-qrcode-display')) {
                setTimeout(() => { 
                    generateQRCode(generatedTicketUrl, 'attendee-ticket-qrcode-display', 200); 
                }, 0);
            }
            if (generatedTicketUrl && currentView === 'eventDetails' && document.getElementById('event-details-qrcode-display')) {
                setTimeout(() => { 
                    generateQRCode(generatedTicketUrl, 'event-details-qrcode-display', 256); 
                }, 0);
            }


            // Add event listener for the event form if present (for create/edit event view)
            if (currentView === 'createEvent') {
                const eventFormElement = document.getElementById('event-form');
                if (eventFormElement) {
                    eventFormElement.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const name = document.getElementById('eventName').value;
                        const date = document.getElementById('eventDate').value;
                        const location = document.getElementById('eventLocation').value;
                        const description = document.getElementById('eventDescription').value;
                        handleCreateOrUpdateEvent({ name, date, location, description });
                    });
                }
            }
        };

        const renderAccessDenied = () => `
            <div class="text-center p-10 content-card">
                <h2 class="text-3xl font-bold mb-4 text-gray-900">Access Denied</h2>
                <p class="text-lg text-gray-700">Please log in to access this section.</p>
                <button onclick="redirectToCognitoLogin()" class="mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">
                    Go to Login
                </button>
            </div>
        `;

        // --- View Navigation ---
        // handleHomeButtonClick: Directs to dashboard if logged in, otherwise to home.
        const handleHomeButtonClick = () => {
            if (loggedInUser) {
                if (loggedInUser.role === 'organizer') {
                    setView('organizerDashboard');
                } else if (loggedInUser.role === 'attendee') {
                    setView('attendeePortal');
                } else { // Should ideally not happen if role assigned
                    setView('chooseRoleAfterLogin');
                }
            } else {
                setView('home');
            }
            // Ensure events are re-fetched if navigating back to dashboard view
            if (loggedInUser && (currentView === 'organizerDashboard' || currentView === 'attendeePortal')) {
                fetchEventsFromAPI();
            }
        };

        // setView now manages history state to prevent direct back to Cognito login
        const setView = (viewName) => {
            currentView = viewName;
            // Push state only if navigating to a "main" section that should be in browser history
            // Avoid pushing for modals or temporary states.
            const path = window.location.pathname; // Base path
            const newUrl = `${path}#${viewName}`; // Append view as hash
            
            // To prevent back button going to Cognito login, we use replaceState after initial login
            // For internal app navigation, pushState can be used, but for a simple SPA
            // where we don't want deep linking to internal views, managing view state is simpler.
            // The key is that `parseCognitoTokens` uses `replaceState` after initial login.
            // For simple view changes, just re-rendering the content is sufficient.
            // The browser's back button will still traverse the browser's history,
            // which should now be cleaner due to `replaceState` on login.
            renderUI(); 
        };

        // --- Mock Event Data (Initial Load) ---
        const loadInitialMockData = () => {
            events = [
                { id: 'e1', name: 'Tech Innovation Summit (Mock)', date: '2025-07-20', description: 'Explore the latest in AI and blockchain.', location: 'Convention Center', organizerId: 'org1', registeredAttendees: [] },
                { id: 'e2', name: 'Digital Art Expo (Mock)', date: '2525-08-15', description: 'A showcase of stunning digital masterpieces.', location: 'Art Gallery', organizerId: 'org1', registeredAttendees: [] },
                { id: 'e3', name: 'Local Music Festival (Mock)', date: '2025-09-01', description: 'Enjoy live performances from local bands.', location: 'City Park', organizerId: 'org2', registeredAttendees: [] },
            ];
            renderUI();
        };

        // --- Authentication Logic (Cognito Hosted UI Integration) ---
        const redirectToCognitoLogin = () => {
            const loginUrl = `https://${COGNITO_DOMAIN}/login?response_type=token&client_id=${COGNITO_USER_POOL_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_SIGN_IN_URL)}`;
            window.location.assign(loginUrl);
        };

        const redirectToCognitoSignup = () => {
            const signupUrl = `https://${COGNITO_DOMAIN}/signup?response_type=token&client_id=${COGNITO_USER_POOL_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_SIGN_IN_URL)}`;
            window.location.assign(signupUrl);
        };

        const handleLogout = () => {
            // Clear localStorage upon logout
            localStorage.removeItem('id_token');
            localStorage.removeItem('access_token');
            const logoutUrl = `https://${COGNITO_DOMAIN}/logout?client_id=${COGNITO_USER_POOL_CLIENT_ID}&logout_uri=${encodeURIComponent(REDIRECT_SIGN_OUT_URL)}`;
            window.location.assign(logoutUrl);
        };

        // Function to parse JWT tokens from the URL hash after Cognito redirect OR from localStorage
        const parseCognitoTokens = () => {
            const hash = window.location.hash.substring(1); 
            const params = new URLSearchParams(hash);
            let idToken = params.get('id_token');
            let accessToken = params.get('access_token');
            
            // Flag to check if tokens came from URL hash (fresh login)
            const isFreshLogin = !!idToken;

            // If tokens are in URL hash, prioritize them and store in localStorage
            if (isFreshLogin) {
                localStorage.setItem('id_token', idToken);
                localStorage.setItem('access_token', accessToken);
                // Immediately clear hash from URL to prevent re-processing on refresh
                // and to clean browser history.
                window.history.replaceState({}, document.title, window.location.pathname + window.location.search);
            } else {
                // If not in URL hash, try to retrieve from localStorage
                idToken = localStorage.getItem('id_token');
                accessToken = localStorage.getItem('access_token');
            }

            if (idToken) {
                try {
                    const payload = JSON.parse(atob(idToken.split('.')[1])); 
                    const now = Math.floor(Date.now() / 1000); // Current time in seconds since epoch
                    
                    // Check if token is expired (giving a small grace period)
                    if (payload.exp < (now - 60)) { // 60 seconds grace period
                        console.warn('Stored ID token is expired. User needs to re-authenticate.');
                        localStorage.removeItem('id_token');
                        localStorage.removeItem('access_token');
                        loggedInUser = null;
                        showAlert('Session Expired', 'Your session has expired. Please log in again.');
                        setView('home'); // Go to home to prompt re-login
                        return; // Stop execution
                    }

                    loggedInUser = {
                        id: payload.sub, 
                        email: payload.email, 
                        // Directly use the role from claims if present, otherwise mark unassigned
                        role: (payload['cognito:groups'] && payload['cognito:groups'].length > 0) ? 
                              (payload['cognito:groups'].includes('Organizers') ? 'organizer' : 'attendee') : 
                              'unassigned', 
                        idToken: idToken,     
                        accessToken: accessToken 
                    };
                    
                    // Only show login success alert if it's a fresh login from Cognito redirect
                    if (isFreshLogin) { 
                        showAlert('Login Successful', `Welcome, ${loggedInUser.email}!`);
                    }

                    if (loggedInUser.role === 'unassigned') {
                        setView('chooseRoleAfterLogin');
                    } else if (loggedInUser.role === 'organizer') {
                        setView('organizerDashboard');
                        fetchEventsFromAPI(); 
                    } else { // Must be attendee
                        setView('attendeePortal');
                        fetchEventsFromAPI(); 
                    }
                } catch (e) {
                    console.error("Error parsing ID token:", e);
                    showAlert('Authentication Error', 'Could not parse user session. Please try logging in again.');
                    localStorage.removeItem('id_token'); // Clear corrupted tokens
                    localStorage.removeItem('access_token');
                    loggedInUser = null;
                    setView('home'); 
                }
            } else {
                // If no token in hash or localStorage, and not a logout redirect
                if (!window.location.search.includes('logout=true')) {
                    loggedInUser = null; 
                    setView('home'); 
                } else {
                    // Handle explicit logout redirect
                    showAlert('Logged Out', 'You have been successfully logged out.');
                    window.history.replaceState({}, document.title, window.location.pathname); 
                    loggedInUser = null;
                    setView('home'); 
                }
            }
            renderUI(); 
        };

        // --- New Function: Handle Role Assignment via API Call ---
        const handleAssignRole = async (role) => {
            if (!loggedInUser || !loggedInUser.id || !loggedInUser.idToken) {
                showAlert('Error', 'You must be logged in to assign a role.');
                setView('home');
                return;
            }

            if (!API_GATEWAY_UPDATE_ROLE_URL || API_GATEWAY_UPDATE_ROLE_URL.includes('YOUR_API_GATEWAY_INVOKE_URL_HERE')) {
                showAlert('Configuration Error', 'The API_GATEWAY_UPDATE_ROLE_URL is not configured. Please update it in index.html.');
                console.error("API_GATEWAY_UPDATE_ROLE_URL is not set! Please replace 'YOUR_API_GATEWAY_INVOKE_URL_HERE' with your actual API Gateway Invoke URL.");
                return;
            }

            try {
                showAlert('Assigning Role', `Assigning you as a "${role}"... Please wait.`); 
                const response = await fetch(API_GATEWAY_UPDATE_ROLE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${loggedInUser.idToken}` 
                    },
                    body: JSON.stringify({
                        userId: loggedInUser.id, 
                        role: role               
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Failed to assign role: ${response.status} ${errorData.message || response.statusText}`);
                }
                
                // --- FIX: Update local loggedInUser role and redirect directly ---
                loggedInUser.role = role; // Update the frontend user object with the new role
                showAlert('Role Assigned!', `You are now an ${role}.`); // Removed re-login instruction
                
                // Immediately navigate to the correct dashboard based on the newly assigned role
                if (loggedInUser.role === 'organizer') {
                    setView('organizerDashboard');
                    fetchEventsFromAPI(); // Fetch events specific to organizer
                } else { // Must be attendee
                    setView('attendeePortal');
                    fetchEventsFromAPI(); // Fetch all events for attendee
                }

            } catch (error) {
                console.error('Error assigning role:', error);
                showAlert('Role Assignment Failed', `Could not assign role: ${error.message}. Please try again or contact support.`);
                // If assignment fails, keep them on role selection page or redirect to home.
                setView('chooseRoleAfterLogin'); 
            }
        };

        // --- API Calls (Backend Integration) ---
        const fetchEventsFromAPI = async () => {
            if (!loggedInUser) {
                console.warn('Cannot fetch events: No user logged in. Displaying mock data.');
                loadInitialMockData();
                return; 
            }

            if (!API_GATEWAY_EVENTS_URL || API_GATEWAY_EVENTS_URL.includes('YOUR_API_GATEWAY_INVOKE_URL_HERE')) {
                showAlert('Configuration Error', 'The API_GATEWAY_EVENTS_URL is not configured. Please update it in index.html.');
                console.error("API_GATEWAY_EVENTS_URL is not set! Please replace 'YOUR_API_GATEWAY_INVOKE_URL_HERE' with your actual API Gateway Invoke URL.");
                loadInitialMockData(); // Fallback to mock data if API URL is missing
                return;
            }

            try {
                // Do not show "Loading Events" alert every time fetchEventsFromAPI is called,
                // only if it's the initial load or explicitly navigating.
                if (currentView === 'organizerDashboard' || currentView === 'attendeePortal') {
                    // Only show alert if it's the primary action for the view
                }
                
                const response = await fetch(API_GATEWAY_EVENTS_URL, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${loggedInUser.idToken}` 
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json(); 
                    throw new Error(`API error: ${response.status} ${errorData.message || response.statusText}`);
                }

                const data = await response.json();
                events = data.events || data; 
                console.log('Fetched events successfully:', events);
                renderUI(); 
            } catch (error) {
                console.error('Error fetching events:', error);
                showAlert('Error', `Failed to load events from backend: ${error.message}. Please check your API Gateway URL and Lambda permissions. Displaying mock data.`);
                loadInitialMockData();
            }
        };

        const handleCreateOrUpdateEvent = async ({ name, date, location, description }) => {
            if (!loggedInUser || loggedInUser.role !== 'organizer') {
                showAlert('Error', 'Unauthorized: Only organizers can create/edit events.');
                return;
            }
            if (!name || !date || !location) {
                showAlert('Input Error', 'Event Name, Date, and Location are required.');
                return;
            }

            if (!API_GATEWAY_EVENTS_URL || API_GATEWAY_EVENTS_URL.includes('YOUR_API_GATEWAY_INVOKE_URL_HERE')) {
                showAlert('Configuration Error', 'The API_GATEWAY_EVENTS_URL for creation/update is not configured. Please update it in index.html.');
                console.error("API_GATEWAY_EVENTS_URL is not set! Please replace 'YOUR_API_GATEWAY_INVOKE_URL_HERE' with your actual API Gateway Invoke URL.");
                return;
            }

            const eventData = {
                id: editingEventId || `e-${Date.now()}`, 
                name,
                date,
                location,
                description,
                organizerId: loggedInUser.id, 
                registeredAttendees: editingEventId ? (events.find(e => e.id === editingEventId)?.registeredAttendees || []) : []
            };

            const method = editingEventId ? 'PUT' : 'POST';
            const apiUrl = editingEventId ? `${API_GATEWAY_EVENTS_URL}/${editingEventId}` : API_GATEWAY_EVENTS_URL; 

            try {
                showAlert('Creating/Updating Event', 'Processing your event...');
                const response = await fetch(apiUrl, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${loggedInUser.idToken}` 
                    },
                    body: JSON.stringify(eventData) 
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} ${errorData.message || response.statusText}`);
                }

                showAlert('Success', `Event ${editingEventId ? 'updated' : 'created'} successfully!`);
                editingEventId = null; 
                form = { name: '', date: '', description: '', location: '', organizerId: '' }; 
                await fetchEventsFromAPI(); 
                setView('organizerDashboard'); 
            } catch (error) {
                console.error('Error creating/updating event:', error);
                showAlert('Error', `Failed to ${editingEventId ? 'update' : 'create'} event: ${error.message}. Please check your Lambda logic and API Gateway setup.`);
            }
        };

        const handleEditEventClick = (eventId) => {
            editingEventId = eventId;
            const eventToEdit = events.find(event => event.id === eventId);
            if (eventToEdit) {
                form = { ...eventToEdit }; // Pre-fill form
                setView('createEvent'); // Re-use create form for editing
            } else {
                showAlert('Error', 'Event not found for editing.');
            }
        };


        const handleDeleteEvent = (id) => {
            showConfirm('Delete Event', 'Are you sure you want to delete this event? This action cannot be undone.', async () => {
                if (!loggedInUser || loggedInUser.role !== 'organizer') {
                    showAlert('Error', 'Unauthorized: Only organizers can delete events.');
                    return;
                }
                
                if (!API_GATEWAY_EVENTS_URL || API_GATEWAY_EVENTS_URL.includes('YOUR_API_GATEWAY_INVOKE_URL_HERE')) {
                    showAlert('Configuration Error', 'The API_GATEWAY_EVENTS_URL for deletion is not configured. Please update it in index.html.');
                    console.error("API_GATEWAY_EVENTS_URL is not set! Please replace 'YOUR_API_GATEWAY_INVOKE_URL_HERE' with your actual API Gateway Invoke URL.");
                    return;
                }

                try {
                    showAlert('Deleting Event', 'Processing deletion...');
                    const response = await fetch(`${API_GATEWAY_EVENTS_URL}/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${loggedInUser.idToken}` 
                        }
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API error: ${response.status} ${errorData.message || response.statusText}`);
                    }
                    showAlert('Success', 'Event deleted successfully!');
                    await fetchEventsFromAPI(); 
                    setView('organizerDashboard');
                } catch (error) {
                    console.error('Error deleting event:', error);
                    showAlert('Error', `Failed to delete event: ${error.message}.`);
                }
            });
        };

        // COMBINED Register and De-register logic
        const handleRegisterOrDeregisterForEvent = async (eventId, actionType) => {
            if (!loggedInUser || loggedInUser.role !== 'attendee') {
                showAlert('Error', 'Please log in as an attendee to register/de-register.');
                return;
            }

            const eventToModify = events.find(e => e.id === eventId);
            if (!eventToModify) {
                showAlert('Error', 'Event not found.');
                return;
            }

            let updatedAttendees = [...eventToModify.registeredAttendees]; // Create a copy
            const isRegistered = updatedAttendees.includes(loggedInUser.id);

            if (actionType === 'register') {
                if (isRegistered) {
                    showAlert('Already Registered', 'You are already registered for this event.');
                    return;
                }
                updatedAttendees.push(loggedInUser.id);
                handleMockPayment(99.99, 'USD', eventToModify.name); // Mock payment for registration
            } else if (actionType === 'deregister') {
                if (!isRegistered) {
                    showAlert('Not Registered', 'You are not registered for this event.');
                    return;
                }
                // Use a confirm dialog for deregistration
                showConfirm('Confirm De-registration', `Are you sure you want to de-register from "${eventToModify.name}"?`, async () => {
                    // User confirmed, proceed with API call
                    updatedAttendees = updatedAttendees.filter(id => id !== loggedInUser.id);
                    try {
                        showAlert('De-registering', 'Processing your de-registration...');
                        const response = await fetch(`${API_GATEWAY_EVENTS_URL}/${eventId}`, { 
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${loggedInUser.idToken}` 
                            },
                            body: JSON.stringify({ registeredAttendees: updatedAttendees })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(`API error: ${response.status} ${errorData.message || response.statusText}`);
                        }
                        showAlert('Success', `You have successfully de-registered from "${eventToModify.name}"!`);
                        await fetchEventsFromAPI(); 
                    } catch (error) {
                        console.error('Error de-registering:', error);
                        showAlert('Error', `Failed to de-register: ${error.message}.`);
                    }
                }, () => {
                    // User cancelled, do nothing
                    showAlert('De-registration Cancelled', 'De-registration process was cancelled.');
                    return; // Exit here, no API call
                });
                return; // Exit here if deregister action, as API call is within showConfirm callback
            } else {
                showAlert('Error', 'Invalid action type.');
                return;
            }

            // This part runs only for 'register' action if it's not already registered
            try {
                showAlert('Registering for Event', 'Processing your registration...');
                const response = await fetch(`${API_GATEWAY_EVENTS_URL}/${eventId}`, { 
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${loggedInUser.idToken}` 
                    },
                    body: JSON.stringify({ registeredAttendees: updatedAttendees })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} ${errorData.message || response.statusText}`);
                }
                showAlert('Success', `You have successfully registered for "${eventToModify.name}"!`);
                await fetchEventsFromAPI(); 
            } catch (error) {
                console.error('Error registering:', error);
                showAlert('Error', `Failed to register: ${error.message}.`);
            }
        };


        const handleDownloadTicket = async (eventId) => {
            if (!loggedInUser || loggedInUser.role !== 'attendee') {
                showAlert('Error', 'Please log in as an attendee to download tickets.');
                return;
            }

            const event = events.find(e => e.id === eventId);
            if (!event) {
                showAlert('Error', 'Event not found.');
                return;
            }
            if (!event.registeredAttendees.includes(loggedInUser.id)) {
                showAlert('Not Registered', 'You are not registered for this event. Please register first.');
                return;
            }

            if (!API_GATEWAY_GET_TICKET_URL || API_GATEWAY_GET_TICKET_URL.includes('YOUR_API_GATEWAY_INVOKE_URL_HERE')) {
                showAlert('Configuration Error', 'The API_GATEWAY_GET_TICKET_URL is not configured. Please update it in index.html.');
                console.error("API_GATEWAY_GET_TICKET_URL is not set! Please replace 'YOUR_API_GATEWAY_INVOKE_URL_HERE' with your actual API Gateway Invoke URL.");
                return;
            }

            try {
                showAlert('Generating Ticket', 'Fetching your ticket. This may take a moment...');

                const response = await fetch(API_GATEWAY_GET_TICKET_URL, {
                    method: 'POST', 
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${loggedInUser.idToken}` 
                    },
                    body: JSON.stringify({
                        eventId: event.id,
                        eventName: event.name,
                        eventDate: event.date,
                        eventLocation: event.location,
                        attendeeId: loggedInUser.id,
                        attendeeEmail: loggedInUser.email 
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} ${errorData.message || response.statusText}`);
                }

                const data = await response.json();
                const ticketUrl = data.ticketUrl;

                if (ticketUrl) {
                    generatedTicketUrl = ticketUrl; // Store the URL for QR code generation
                    showAlert('Ticket Ready!', 'Your ticket is ready. Clicking OK will open the download.');
                    window.open(ticketUrl, '_blank'); // This will trigger the download due to S3 Content-Disposition
                    currentEvent = event; // Keep event context for QR code display
                    renderUI(); // Re-render to display the QR code
                } else {
                    throw new Error('No ticket URL received from backend.');
                }

            } catch (error) {
                console.error('Error downloading ticket:', error);
                showAlert('Ticket Download Failed', `Could not download ticket: ${error.message}. Please try again or contact support.`);
            }
        };

        const handleMockPayment = (amount, currency, eventName) => {
            showAlert('Payment Simulation', `Simulating payment of ${amount} ${currency} for "${eventName}". (This is a mock. Real integration later).`);
            console.log('Mock payment processed.');
        };

        const viewEventDetails = (id) => {
            currentEvent = events.find(e => e.id === id);
            // If already registered and a ticket URL was generated previously, show QR
            // Also ensure we only show the QR if there's a valid ticket URL
            if (loggedInUser && currentEvent && currentEvent.registeredAttendees.includes(loggedInUser.id) && generatedTicketUrl) {
                // Do nothing, generatedTicketUrl will be picked up by renderUI
            } else {
                generatedTicketUrl = null; // Clear if not registered or no ticket yet
            }
            setView('eventDetails');
        };

        // --- Initial Application Load Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            parseCognitoTokens(); 
        });
    </script>
</body>
</html>
